<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title> Chat Room </title>
    {%load static%}
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400&display=swap" rel="stylesheet">
    <!-- FAVICON -->
    <link rel="shortcut icon" href="{% static 'img/favicon.png' %}" type="image/x-icon">
    <!-- JAVASCRIPT -->
    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js'%}"></script>
    <!-- Bootstrap 3-->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" media="screen">
    <!-- CSS -->
    <link href="{% static 'css/chat-room.css' %}" rel="stylesheet" media="screen">
    <!-- ICONS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css"/>
</head>
<body translate="no">
    {%load static%}
    {% csrf_token %}
    <div class="container clearfix">
            <div class="chat">
                <div class="chat-header clearfix">
                    <div class="image round" style="margin-right: 5%;">
                        <img src="{{person.img_url}}" alt="avatar" />
                    </div><br>
                    
                    
                    <div class="chat-about" style="padding-left: 7%;">
                      <div class="chat-with" style="font-size: 20pt;"> {{person.name}} </div>
                    </div><br>
                    <form action="/chat/out/" method="post">
                        {% csrf_token %}
                        <input type = hidden name = room_id value="{{room_id}}">
                        <button type="submit" class="exit" style="float: right; margin-left: 2%;" >
                            <i class="fas fa-sign-out-alt fa-2x" aria-hidden="true" ></i>
                        </button>
                    </form>
                        <i style="float: right; cursor: pointer;" class= "fas fa-stream fa-2x" aria-hidden="true" onclick="location.href='/chat/'"></i>
                </div>
                <div class="chat-history" id="chat-history">
                    <textarea class="message my-message" id="chat-log" cols="10" rows="10" >
                        {%for message in messages%}
                        {%if message.writer == request.session.member_id%} 나 : {{message.message}} 
                        {%else%}{{message.writer}} : {{message.message}} 
                        {%endif%}
                        {%endfor%}
                    </textarea>
                    {%for message in messages%}
                    {%if message.writer == request.session.member_id%}<div id =me style='margin-right: 0px;'>{{message.message}} </div>
                    {%else%}<div id =me style='margin-left: 0px;'>{{message.writer}} : {{message.message}} </div>
                    {%endif%}
                    {%endfor%}
                </div>
                <div id = last class=last></div>
                        <div class="chat-message clearfix">
                            <form name = f1 id = f1 action="{%url 'dbconnect'%}" method = POST>
                                {% csrf_token %}
                                <input hidden="hidden" />
                                <textarea id="message-to-send" placeholder="Type your message" cols="10" rows="3" style="resize: none;"></textarea>
                                <input id = message name = message type = hidden>
                                <input id = room_id name = room_id type = hidden value = {{room_id}}>
                                <button id="chat-message-submit"> Send </button>
                            </form>
                        </div>
            </div>
        </div>
    </div>
</body>
<script>
    $(document).ready(function(){
        $(".container").scrollTop($(".container")[0].scrollHeight);
        autosize($("textarea"));
        $(".chat-history").scrollTop($(".chat-history")[0].scrollHeight);
    });
  </script>
<script>
    var roomName = {{ room_name_json }};

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        document.find("div.last").prepend(message);
        document.querySelector('#chat-log').value += ("나 : "+message + '\n');
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#message-to-send').focus();
    document.querySelector('#message-to-send').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
            }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        if($.trim($("#message-to-send").val())==''){
        return false;
        } 
        document.getElementById('message').value = document.getElementById('message-to-send').value 
        var messageInputDom = document.querySelector('#message-to-send');
        var message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
        'message':message
        }));
        f1.submit(); 
        messageInputDom.value = '';
    };
</script>
<script src="https://rawgit.com/jackmoore/autosize/master/dist/autosize.min.js"></script>
</html>