<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title> Chat Room </title>
    {%load static%}
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400&display=swap" rel="stylesheet">
    <!-- FAVICON -->
    <link rel="shortcut icon" href="{% static 'img/favicon.png' %}" type="image/x-icon">
    <!-- JAVASCRIPT -->
    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js'%}"></script>
    <script src="{% static 'js/animatescroll.js' %}"></script>
    <script src="{% static 'js/index.js' %}"></script>
    <script src="{% static 'js/retina.min.js' %}"></script>
    <!-- Bootstrap 3-->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" media="screen">
    <!-- CSS -->
    <link href="{% static 'css/chat-room.css' %}" rel="stylesheet" media="screen">
</head>
<body translate="no">
    {%load static%}

    <a href='/chat/'> 목록 보기 </a>
    <form action="/chat/out/" method="post">
    {% csrf_token %}
    <input type = hidden name = room_id value="{{room_id}}">
    <input type = submit value = "나가기">
    </form>

    <div class="container clearfix">
        <div class="people-list" id="people-list">
            
            <div class="chat">
                <div class="chat-header clearfix">
                    <img src="{{person.img_url}}" alt="avatar" />
                    <div class="chat-about">
                      <div class="chat-with">Chat with Vincent Porter</div>
                      <div class="chat-num-messages">already 1 902 messages</div>
                    </div>
                </div>
                <div class="chat-history">
                    <ul>
                        <li>
                            <textarea class="message my-message" id="chat-log" cols="100" rows="20">
                                {%for message in messages%}
                                {%if message.writer == request.session.member_id%}나 : {{message.message}} 
                                {%else%}{{message.writer}} : {{message.message}} 
                                {%endif%}
                                {%endfor%}
                            </textarea>
                        </li>
                </div>
                        <div class="chat-message clearfix">
                            <form name = f1 id=f1 action="{%url 'dbconnect'%}" method = POST>
                                {% csrf_token %}
                                <textarea id="message-to-send" placeholder="Type your message" rows="3"></textarea>
                                <input id = message name = message type = hidden>
                                <input id = room_id name = room_id type = hidden value = {{room_id}}>
                                <input  class="full-width has-padding checkID" id="chat-message-submit" type="button" value="Send"/>
                            </form>
                        </div>
            </div>
        </div>
    </div>
</body>

<script>
    var roomName = {{ room_name_json }};

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        document.querySelector('#chat-log').value += (message + '\n');
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        document.getElementById('message').value = document.getElementById('chat-message-input').value 
        var messageInputDom = document.querySelector('#chat-message-input');
        var message = messageInputDom.value;
        if (message != ''){
            chatSocket.send(JSON.stringify({
                'message':message
            }));

            messageInputDom.value = '';
            f1.submit();
        }
    };
</script>

</html>